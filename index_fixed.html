<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Daugybos Testas – Balsu</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:#0f1220;color:#e8ebff}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#171a2b;position:sticky;top:0}
    button,select{background:#222643;border:1px solid #2c3158;color:#e8ebff;padding:8px 12px;border-radius:8px;cursor:pointer}
    main{padding:10px}
    .stat{background:#111427;border:1px solid #242844;padding:6px 10px;border-radius:8px;margin-right:6px;display:inline-block}
    .kbd{background:#0b0e1d;border:1px solid #2c3158;border-bottom:2px solid #0b0e1d;padding:6px 10px;border-radius:8px;font-weight:700}
    .toast{position:fixed;top:14px;left:50%;transform:translateX(-50%);padding:10px 14px;background:#10132a;border:1px solid #2f3462;border-radius:12px;display:none}
    .toast.show{display:block}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
<header>
  <div style="font-weight:700">🎯 Daugybos Testas – Balsu</div>
  <div class="row">
    <button id="toggleTTS">🔊 Balsu: IŠJ</button>
    <button id="toggleSTT">🎤 Atsakymas balsu: IŠJ</button>
    <select id="voiceSelect" title="Balsas"></select>
  </div>
</header>
<main>
  <div class="stat">Tikslumas: <b id="acc">–</b></div>
  <div class="stat">Streak: <b id="streak">0</b></div>
  <div class="stat">Silpnos: <b id="weak">–</b></div>
  <div class="row" style="margin-top:10px">
    <span class="kbd" id="prompt">7 × 8 = ?</span>
    <input id="answer" class="kbd" style="min-width:80px;text-align:center" inputmode="numeric" autocomplete="off" autocapitalize="none" autocorrect="off" placeholder="ats.">
    <button id="submit">OK</button>
    <button id="skip">Praleisti</button>
    <button id="reveal">👁️</button>
  </div>
</main>
<div id="toast" class="toast" role="status" aria-live="polite"></div>
<script>
(()=>{
  const promptEl=document.getElementById('prompt'),answerEl=document.getElementById('answer');
  const accEl=document.getElementById('acc'),streakEl=document.getElementById('streak'),weakEl=document.getElementById('weak');
  const toast=document.getElementById('toast');
  function showToast(msg){toast.textContent=msg;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1400);}

  // --- State with persistence ---
  const saved = JSON.parse(localStorage.getItem('daugyba_state')||'{}');
  const state={correct: saved.correct||0, total: saved.total||0, streak: saved.streak||0, mistakes: saved.mistakes||{}};
  function save(){ localStorage.setItem('daugyba_state', JSON.stringify(state)); }
  function updateStats(){
    accEl.textContent = state.total ? (Math.round(100*state.correct/state.total)+'%') : '–';
    streakEl.textContent = state.streak;
    const e=Object.entries(state.mistakes).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k])=>k);
    weakEl.textContent = e.length ? e.join(', ') : '–';
  }

  function pickRandom(){
    // Weighted by mistakes (more mistakes -> higher chance)
    const pairs=[];
    for(let a=1;a<=10;a++) for(let b=1;b<=10;b++){
      const w = 1 + (state.mistakes[`${a}×${b}`]||0);
      pairs.push({a,b,w});
    }
    const total = pairs.reduce((s,p)=>s+p.w,0);
    let r = Math.random()*total;
    for(const p of pairs){ if((r-=p.w)<=0) return {a:p.a,b:p.b}; }
    return {a:7,b:8};
  }

  let current={a:7,b:8};
  function ask(){ current=pickRandom(); promptEl.textContent=`${current.a} × ${current.b} = ?`; speakQ(); answerEl.value=""; answerEl.focus(); }
  function markWrong(){ state.total++; state.streak=0; save(); updateStats(); }
  function markCorrect(){ state.total++; state.correct++; state.streak++; save(); updateStats(); }
  function submit(){
    const val = parseInt(answerEl.value,10);
    if (Number.isNaN(val)) return;
    const prod=current.a*current.b;
    if (val===prod){ showToast("✅ Teisingai!"); speakF(true,prod); markCorrect(); ask(); }
    else { showToast(`❌ Ne – ${prod}`); speakF(false,prod); markWrong(); state.mistakes[`${current.a}×${current.b}`]=(state.mistakes[`${current.a}×${current.b}`]||0)+1; save(); ask(); }
  }
  document.getElementById('submit').onclick=submit;
  document.getElementById('skip').onclick=()=>ask();
  document.getElementById('reveal').onclick=()=>showToast(`${current.a}×${current.b}=${current.a*current.b}`);
  answerEl.addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });

  // --- Voice (TTS/STT) ---
  const toggleTTS=document.getElementById('toggleTTS');
  const toggleSTT=document.getElementById('toggleSTT');
  const voiceSel=document.getElementById('voiceSelect');

  const synth = window.speechSynthesis;
  let voices=[], selVoice=null, ttsOn=false, sttOn=false;

  function populateVoices(){
    voices = synth ? synth.getVoices() : [];
    voiceSel.innerHTML = "";
    if (!voices.length){
      const opt=document.createElement('option');
      opt.textContent = '(balsų nerasta)';
      opt.value = '';
      voiceSel.appendChild(opt);
      selVoice = null;
      return;
    }
    const pref = voices.filter(v=>/lt|Lithuanian/i.test(v.lang));
    const list = pref.length ? pref : voices;
    list.forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`;
      voiceSel.appendChild(opt);
    });
    selVoice = voices.find(v=>v.name===voiceSel.value) || list[0] || voices[0];
  }
  if (synth){
    populateVoices();
    // Some browsers load voices async
    if (typeof synth.onvoiceschanged !== 'undefined'){
      synth.onvoiceschanged = populateVoices;
    }
  } else {
    // No TTS support
    const opt=document.createElement('option');
    opt.textContent='(TTS nepalaikomas)';
    opt.value=''; voiceSel.appendChild(opt);
  }
  voiceSel.onchange = ()=>{ selVoice = voices.find(v=>v.name===voiceSel.value) || selVoice; };

  function speak(text){
    if (!ttsOn || !synth) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = (selVoice && selVoice.lang) || 'lt-LT';
    if (selVoice) u.voice = selVoice;
    try { synth.cancel(); synth.speak(u); } catch(e) {}
  }
  function speakQ(){
    if (!ttsOn) return;
    speak(`${current.a} kart ${current.b}. Kiek bus?`);
    if (sttOn) startListening();
  }
  function speakF(ok, prod){
    if (!ttsOn) return;
    if (ok) speak("Teisingai!");
    else speak(`Ne. Teisingas atsakymas: ${prod}.`);
  }
  toggleTTS.onclick = ()=>{
    ttsOn = !ttsOn;
    showToast(`Balsas: ${ttsOn? "Įjungtas" : "Išjungtas"}`);
    if (ttsOn) speak("Balso režimas įjungtas. Pradedame.");
  };

  // STT
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recog = null;
  function startListening(){
    if (!sttOn || !Rec) return;
    if (recog){ try{recog.stop();}catch(e){} recog = null; }
    recog = new Rec();
    recog.lang = 'lt-LT';
    recog.interimResults = false;
    recog.maxAlternatives = 1;
    recog.onresult = (e)=>{
      const txt = (e.results[0] && e.results[0][0] && e.results[0][0].transcript || "").trim();
      const num = parseInt(txt.replace(/[^0-9]/g,''),10);
      if (!Number.isNaN(num)){ answerEl.value = String(num); submit(); }
      else { showToast("Nesupratau skaičiaus 🎤"); speak("Nesupratau. Pakartok."); }
    };
    recog.onerror = ()=>{ showToast("STT klaida / nepalaikoma 🎤"); };
    try { recog.start(); } catch(e){ /* ignore */ }
  }
  toggleSTT.onclick = ()=>{
    sttOn = !sttOn;
    showToast(`Ats. balsu: ${sttOn? "Įjungtas" : "Išjungtas"}`);
    if (sttOn && !Rec){ showToast("Ši naršyklė nepalaiko atpažinimo."); }
  };

  // Init
  updateStats();
  ask();
})();
</script>
</body>
</html>
